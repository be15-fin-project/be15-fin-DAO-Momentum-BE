<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dao.momentum.evaluation.hr.query.mapper.EvaluationHrMapper">

    <!-- 1) 페이징된 HR 평가 내역 목록 조회 -->
    <select id="findHrEvaluations"
            parameterType="map"
            resultType="com.dao.momentum.evaluation.hr.query.dto.response.HrEvaluationItemDto">
        SELECT
            r.round_no              AS round_no,
            CASE
                WHEN er.score >= 95 THEN '탁월'
                WHEN er.score >= 85 THEN '우수'
                WHEN er.score >= 70 THEN '양호'
                WHEN er.score >= 60 THEN '주의'
                ELSE '미흡'
            END                     AS overall_grade,
            er.created_at           AS evaluated_at,
            er.result_id            AS result_id
        FROM eval_response er
        JOIN eval_round r  ON er.round_id = r.round_id
        JOIN eval_form  f  ON er.form_id  = f.form_id
        WHERE er.eval_id = #{empId}
            AND f.name = 'HR_REVIEW'
            <if test="req.startDate != null">
                AND r.start_at <![CDATA[>=]]> #{req.startDate}
            </if>
            <if test="req.endDate != null">
                AND r.start_at <![CDATA[<=]]> #{req.endDate}
            </if>
        ORDER BY r.start_at DESC
        LIMIT #{req.offset}, #{req.size}
    </select>

    <!-- 2) 전체 건수 조회 -->
    <select id="countHrEvaluations"
            parameterType="map"
            resultType="long">
        SELECT COUNT(*)
        FROM eval_response er
        JOIN eval_round r  ON er.round_id = r.round_id
        JOIN eval_form  f  ON er.form_id  = f.form_id
        WHERE er.eval_id = #{empId}
            AND f.name = 'HR_REVIEW'
            <if test="req.startDate != null">
                AND r.start_at <![CDATA[>=]]> #{req.startDate}
            </if>
            <if test="req.endDate != null">
                AND r.start_at <![CDATA[<=]]> #{req.endDate}
            </if>
    </select>

    <!-- 3) 단일 평가 결과에 대한 요인별 점수 목록 조회 -->
    <select id="findFactorScores"
            parameterType="long"
            resultType="com.dao.momentum.evaluation.hr.query.dto.response.FactorScoreDto">
        SELECT
            p.name      AS property_name,
            s.score     AS score
        FROM eval_score s
        JOIN eval_property p ON s.property_id = p.property_id
        WHERE s.result_id = #{resultId}
        ORDER BY p.property_id
    </select>

</mapper>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dao.momentum.evaluation.eval.query.mapper.ExcelEvaluationQueryMapper">

    <!-- 사원간 평가 엑셀 다운로드 쿼리 -->
    <select id="selectPeerEvaluationsForExcel"
            resultType="com.dao.momentum.evaluation.eval.query.dto.response.PeerEvaluationExcelDto">
        SELECT
            r.round_no       AS roundNo,
            t.emp_no         AS targetEmpNo,
            t.name           AS targetName,
            d.name           AS departmentName,
            p.name           AS positionName,
            e.emp_no         AS evaluatorEmpNo,
            e.name           AS evaluatorName,
            er.score         AS score,
            DATE_FORMAT(er.created_at, '%Y-%m-%d %H:%i') AS submittedAt
        FROM eval_response er
        JOIN employee t ON er.target_id = t.emp_id
        JOIN employee e ON er.eval_id = e.emp_id
        LEFT JOIN department d ON t.dept_id = d.dept_id
        LEFT JOIN position p   ON t.position_id = p.position_id
        JOIN eval_round r ON er.round_id = r.round_id
        <where>
            <if test="roundId != null">
                AND r.round_id = #{roundId}
            </if>
            <if test="targetEmpNo != null and targetEmpNo != ''">
                AND t.emp_no = #{targetEmpNo}
            </if>
            <if test="evaluatorEmpNo != null and evaluatorEmpNo != ''">
                AND e.emp_no = #{evaluatorEmpNo}
            </if>
            <if test="deptId != null">
                AND t.dept_id = #{deptId}
            </if>
            <if test="positionId != null">
                AND t.position_id = #{positionId}
            </if>
        </where>
        ORDER BY r.round_no DESC, t.emp_no, e.emp_no
        LIMIT 5000
    </select>

</mapper>

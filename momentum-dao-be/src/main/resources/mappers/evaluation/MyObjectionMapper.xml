<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dao.momentum.evaluation.hr.query.mapper.MyObjectionMapper">

    <!-- 본인 이의제기 목록 조회 (원시 점수 + ID/일시) -->
    <select id="findMyObjections"
            resultType="com.dao.momentum.evaluation.hr.query.dto.request.MyObjectionRaw">
        SELECT
            o.objection_id                                AS objectionId,
            DATE_FORMAT(o.created_at, '%Y-%m-%d %H:%i:%s') AS createdAt,
            MAX(CASE WHEN es.property_id = 1 THEN es.score END) AS performanceScore,
            MAX(CASE WHEN es.property_id = 2 THEN es.score END) AS attendanceScore,
            MAX(CASE WHEN es.property_id = 3 THEN es.score END) AS otherScore,
            er.score                                      AS overallScore,
            s.status_type                                AS statusType
        FROM hr_objection o
        JOIN eval_response er
            ON er.result_id = o.result_id
        LEFT JOIN eval_score es
            ON es.result_id = er.result_id
        JOIN status s
              ON o.status_id = s.status_id
        WHERE er.target_id = #{empId}
            <if test="req.statusId != null">
                AND o.status_id = #{req.statusId}
            </if>
        GROUP BY o.objection_id, o.created_at, er.score
        ORDER BY o.created_at DESC
        LIMIT #{req.size} OFFSET #{req.offset}
    </select>

    <!-- 본인 이의제기 총 개수 조회 -->
    <select id="countMyObjections"
            resultType="long">
        SELECT COUNT(*)
        FROM hr_objection o
        JOIN eval_response er
            ON er.result_id = o.result_id
        JOIN status s
            ON o.status_id = s.status_id
        WHERE er.target_id = #{empId}
            <if test="req.statusId != null">
                AND o.status_id = #{req.statusId}
            </if>
    </select>

</mapper>
